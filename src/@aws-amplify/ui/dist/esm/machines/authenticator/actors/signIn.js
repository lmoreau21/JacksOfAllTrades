import{__awaiter as e,__generator as t,__assign as r,__rest as n}from"tslib";import{Auth as i}from"aws-amplify";import s from"lodash/get";import o from"lodash/isEmpty";import{createMachine as a,sendUpdate as c}from"xstate";import{runValidators as d}from"../../../validators/index.js";import{clearAttributeToVerify as u,clearChallengeName as l,clearRequiredAttributes as g,clearError as f,clearFormValues as m,clearTouched as h,clearUnverifiedAttributes as p,clearValidationError as v,handleInput as I,handleSubmit as A,handleBlur as U,parsePhoneNumber as E,setChallengeName as S,setConfirmResetPasswordIntent as b,setConfirmSignUpIntent as y,setRequiredAttributes as T,setCredentials as C,setFieldErrors as w,setRemoteError as N,setUnverifiedAttributes as R,setUser as P,setUsernameAuthAttributes as V}from"../actions.js";import{defaultServices as F}from"../defaultServices.js";var _=["SMS_MFA","SOFTWARE_TOKEN_MFA"],k=function(e){return s(e,"data.challengeName")},D=function(e,t){return e===t},j=function(e){return _.includes(e)};function x(s){var _=s.services;return a({initial:"init",id:"signInActor",predictableActionArguments:!0,states:{init:{always:[{target:"autoSignIn",cond:"shouldAutoSignIn"},{target:"signIn"}]},signIn:{initial:"edit",exit:["clearFormValues","clearTouched"],states:{edit:{entry:"sendUpdate",on:{SUBMIT:{actions:"handleSubmit",target:"submit"},CHANGE:{actions:"handleInput"},FEDERATED_SIGN_IN:"federatedSignIn"}},federatedSignIn:{tags:["pending"],entry:["sendUpdate","clearError"],invoke:{src:"federatedSignIn",onError:{actions:"setRemoteError"}}},submit:{tags:["pending"],entry:["parsePhoneNumber","clearError","sendUpdate"],invoke:{src:"signIn",onDone:[{cond:"shouldSetupTOTP",actions:["setUser","setChallengeName"],target:"#signInActor.setupTOTP"},{cond:"shouldConfirmSignIn",actions:["setUser","setChallengeName"],target:"#signInActor.confirmSignIn"},{cond:"shouldForceChangePassword",actions:["setUser","setChallengeName","setRequiredAttributes"],target:"#signInActor.forceNewPassword"},{actions:"setUser",target:"verifying"}],onError:[{cond:"shouldRedirectToConfirmSignUp",actions:["setCredentials","setConfirmSignUpIntent"],target:"rejected"},{cond:"shouldRedirectToConfirmResetPassword",actions:["setUsernameAuthAttributes","setConfirmResetPasswordIntent"],target:"rejected"},{actions:"setRemoteError",target:"edit"}]}},verifying:{tags:["pending"],entry:["clearError","sendUpdate"],invoke:{src:"checkVerifiedContact",onDone:[{cond:"shouldRequestVerification",target:"#signInActor.verifyUser",actions:"setUnverifiedAttributes"},{target:"resolved"}],onError:{actions:"setRemoteError",target:"edit"}}},resolved:{always:"#signInActor.resolved"},rejected:{always:"#signInActor.rejected"}}},autoSignIn:{initial:"submit",states:{submit:{tags:["pending"],entry:["clearError","sendUpdate"],invoke:{src:"signIn",onDone:[{cond:"shouldSetupTOTP",actions:["setUser","setChallengeName"],target:"#signInActor.setupTOTP"},{cond:"shouldConfirmSignIn",actions:["setUser","setChallengeName"],target:"#signInActor.confirmSignIn"},{cond:"shouldForceChangePassword",actions:["setUser","setChallengeName","setRequiredAttributes"],target:"#signInActor.forceNewPassword"},{actions:"setUser",target:"#signInActor.resolved"}],onError:[{cond:"shouldRedirectToConfirmSignUp",actions:["setCredentials","setConfirmSignUpIntent"],target:"#signInActor.rejected"},{cond:"shouldRedirectToConfirmResetPassword",actions:["setUsernameAuthAttributes","setConfirmResetPasswordIntent"],target:"#signInActor.rejected"},{actions:"setRemoteError",target:"#signInActor.signIn"}]}}}},confirmSignIn:{initial:"edit",exit:["clearFormValues","clearError","clearTouched"],states:{edit:{entry:"sendUpdate",on:{SUBMIT:{actions:"handleSubmit",target:"submit"},SIGN_IN:"#signInActor.signIn",CHANGE:{actions:"handleInput"}}},submit:{tags:["pending"],entry:["clearError","sendUpdate"],invoke:{src:"confirmSignIn",onDone:{target:"#signInActor.resolved",actions:["setUser","clearChallengeName","clearRequiredAttributes"]},onError:{target:"edit",actions:"setRemoteError"}}}}},forceNewPassword:{type:"parallel",exit:["clearFormValues","clearError","clearTouched"],states:{validation:{initial:"pending",states:{pending:{invoke:{src:"validateFields",onDone:{target:"valid",actions:"clearValidationError"},onError:{target:"invalid",actions:"setFieldErrors"}}},valid:{entry:"sendUpdate"},invalid:{entry:"sendUpdate"}},on:{SIGN_IN:"#signInActor.signIn",CHANGE:{actions:"handleInput",target:".pending"},BLUR:{actions:"handleBlur",target:".pending"}}},submit:{initial:"idle",entry:"clearError",states:{idle:{entry:"sendUpdate",on:{SUBMIT:{actions:"handleSubmit",target:"validate"}}},validate:{entry:"sendUpdate",invoke:{src:"validateFields",onDone:{target:"pending",actions:"clearValidationError"},onError:{target:"idle",actions:"setFieldErrors"}}},pending:{tags:["pending"],entry:["sendUpdate","clearError"],invoke:{src:"forceNewPassword",onDone:[{cond:"shouldConfirmSignIn",actions:["setUser","setChallengeName"],target:"#signInActor.confirmSignIn"},{cond:"shouldSetupTOTP",actions:["setUser","setChallengeName"],target:"#signInActor.setupTOTP"},{target:"resolved",actions:["setUser","setCredentials"]}],onError:{target:"idle",actions:"setRemoteError"}}},resolved:{type:"final",always:"#signInActor.resolved"}}}}},setupTOTP:{initial:"edit",exit:["clearFormValues","clearError","clearTouched"],states:{edit:{entry:"sendUpdate",on:{SUBMIT:{actions:"handleSubmit",target:"submit"},SIGN_IN:"#signInActor.signIn",CHANGE:{actions:"handleInput"}}},submit:{tags:["pending"],entry:["sendUpdate","clearError"],invoke:{src:"verifyTotpToken",onDone:{actions:["clearChallengeName","clearRequiredAttributes"],target:"#signInActor.resolved"},onError:{actions:"setRemoteError",target:"edit"}}}}},verifyUser:{initial:"edit",exit:["clearFormValues","clearError","clearTouched"],states:{edit:{entry:"sendUpdate",on:{SUBMIT:{actions:"handleSubmit",target:"submit"},SKIP:"#signInActor.resolved",CHANGE:{actions:"handleInput"}}},submit:{tags:["pending"],entry:"clearError",invoke:{src:"verifyUser",onDone:{target:"#signInActor.confirmVerifyUser"},onError:{actions:"setRemoteError",target:"edit"}}}}},confirmVerifyUser:{initial:"edit",exit:["clearFormValues","clearError","clearUnverifiedAttributes","clearAttributeToVerify","clearTouched"],states:{edit:{entry:"sendUpdate",on:{SUBMIT:{actions:"handleSubmit",target:"submit"},SKIP:"#signInActor.resolved",CHANGE:{actions:"handleInput"}}},submit:{tags:["pending"],entry:"clearError",invoke:{src:"confirmVerifyUser",onDone:{target:"#signInActor.resolved"},onError:{actions:"setRemoteError",target:"edit"}}}}},resolved:{type:"final",data:function(e){return{user:e.user}}},rejected:{type:"final",data:function(e,t){return{intent:e.redirectIntent,authAttributes:e.authAttributes}}}}},{actions:{clearAttributeToVerify:u,clearChallengeName:l,clearRequiredAttributes:g,clearError:f,clearFormValues:m,clearTouched:h,clearUnverifiedAttributes:p,clearValidationError:v,handleInput:I,handleSubmit:A,handleBlur:U,parsePhoneNumber:E,setChallengeName:S,setConfirmResetPasswordIntent:b,setConfirmSignUpIntent:y,setRequiredAttributes:T,setCredentials:C,setFieldErrors:w,setRemoteError:N,setUnverifiedAttributes:R,setUser:P,setUsernameAuthAttributes:V,sendUpdate:c()},guards:{shouldConfirmSignIn:function(e,t){return j(k(t))},shouldAutoSignIn:function(e){return"autoSignIn"===(null==e?void 0:e.intent)},shouldRedirectToConfirmSignUp:function(e,t){return"UserNotConfirmedException"===t.data.code},shouldRedirectToConfirmResetPassword:function(e,t){return"PasswordResetRequiredException"===t.data.code},shouldSetupTOTP:function(e,t){return D(k(t),"MFA_SETUP")},shouldForceChangePassword:function(e,t){return D(k(t),"NEW_PASSWORD_REQUIRED")},shouldRequestVerification:function(e,t){var r=t.data,n=r.unverified,i=r.verified;return o(i)&&!o(n)}},services:{signIn:function(n){return e(this,void 0,void 0,(function(){var e,i,s,o,a,c,d;return t(this,(function(t){switch(t.label){case 0:return e=n.authAttributes,i=void 0===e?{}:e,s=n.formValues,o=void 0===s?{}:s,a=r(r({},i),o),c=a.username,d=a.password,[4,_.handleSignIn({username:c,password:d})];case 1:return[2,t.sent()]}}))}))},confirmSignIn:function(r){return e(this,void 0,void 0,(function(){var e,n,s,o;return t(this,(function(t){switch(t.label){case 0:return e=r.challengeName,n=r.user,s=r.formValues.confirmation_code,o=j(e)?e:void 0,[4,_.handleConfirmSignIn({user:n,code:s,mfaType:o})];case 1:return t.sent(),[4,i.currentAuthenticatedUser()];case 2:return[2,t.sent()]}}))}))},forceNewPassword:function(s){return e(this,void 0,void 0,(function(){var e,o,a,c,d,u,l,g,f;return t(this,(function(t){switch(t.label){case 0:e=s.user,o=s.formValues,a=o.password,o.confirm_password,c=o.phone_number,d=o.country_code,u=n(o,["password","confirm_password","phone_number","country_code"]),c&&(l="".concat(d).concat(c).replace(/[^A-Z0-9+]/gi,""),u=r(r({},u),{phone_number:l})),t.label=1;case 1:return t.trys.push([1,3,,4]),[4,i.completeNewPassword(e,a,u)];case 2:return(g=t.sent()).challengeName?[2,g]:[2,i.currentAuthenticatedUser()];case 3:return f=t.sent(),[2,Promise.reject(f)];case 4:return[2]}}))}))},verifyTotpToken:function(r){return e(this,void 0,void 0,(function(){var e,n,s;return t(this,(function(t){return e=r.formValues,n=r.user,s=e.confirmation_code,[2,i.verifyTotpToken(n,s)]}))}))},federatedSignIn:function(r,n){return e(this,void 0,void 0,(function(){var e;return t(this,(function(t){switch(t.label){case 0:return e=n.data.provider,[4,i.federatedSignIn({provider:e})];case 1:return[2,t.sent()]}}))}))},checkVerifiedContact:function(r){return e(this,void 0,void 0,(function(){var e;return t(this,(function(t){switch(t.label){case 0:return e=r.user,[4,i.verifiedContact(e)];case 1:return[2,t.sent()]}}))}))},verifyUser:function(r){return e(this,void 0,void 0,(function(){var e,n;return t(this,(function(t){switch(t.label){case 0:return e=r.formValues.unverifiedAttr,[4,i.verifyCurrentUserAttribute(e)];case 1:return n=t.sent(),r.attributeToVerify=e,[2,n]}}))}))},confirmVerifyUser:function(r){return e(this,void 0,void 0,(function(){var e,n;return t(this,(function(t){switch(t.label){case 0:return e=r.attributeToVerify,n=r.formValues.confirmation_code,[4,i.verifyCurrentUserAttributeSubmit(e,n)];case 1:return[2,t.sent()]}}))}))},validateFields:function(r){return e(this,void 0,void 0,(function(){return t(this,(function(e){return[2,d(r.formValues,r.touched,r.passwordSettings,[F.validateConfirmPassword])]}))}))}}})}export{x as signInActor};
